# Vulnerability Scanning

## What?

Vulnerability scanning is an important step in software package development, it seeks to identify known potential vulnerabilities and can be automated as part of a CI/CD pipeline. When working in python, safety [^1] checks the dependencies in a package for security vulnerabilities and suggests remediation for the identified vulnerabilities.

When safety is used in conjuction with poetry, a nox session runs poetry export to create a requirements file from the poetry lock file. Thsi requirements file is then cross-referenced with the safety database to identify potential vulnerabilities.

## Why?

Vulnerability scanning is important to protect the wider production environment from potential vulnerabilities introduced by updates deployed to the environment. 

It can occur prior to deployment, minimising the risk to the production code and the service it provides.

It can also be automated as part of the CI/CD pipeline, a version of which is GitHub Actions.

## How?

There are several ways to run safety:
1. ad-hoc via the command-line
1. After you push to GitHub, as part of a CI pipeline

### Via the command-line

You can export the dependencies tracked in poetry using poetry export. 

```sh
poetry export -f requirements.txt
```
You can then run saftey check on the file exported from poetry.

```sh
safety check -r requirements.txt
```

If you project involves package development, a cleaner nore reliable way to do vulnerability scanning is as part of the automated CI/CD pipeline.

### As part of a CI pipeline
This project uses GitHub Actions for Continuous Integration. 
The code to run safety is in the noxfile.py, shown in the following code block. 

```python
@session(python="3.8")
def safety(session: Session) -> None:
    """Scan dependencies for insecure packages."""
    requirements = session.poetry.export_requirements()
    session.install("safety")
    session.run(
        "safety", 
        "check", 
        "--full-report", 
        f"--file={requirements}"
    )
```

The CI workflow is defined in .github/workflows/vulnerability-scanning.yml. This workflow will run the safety checks whenever a change to the poetry.loc or pyproject.toml is pushed to the repo. The code to run safety is called from the noxfile in the last line of the Vulnerability checks workflow specification below.

```yaml
name: Vulnerability checks
on:
  push:
    branches: [ develop ]
    paths:
      - '**/poetry.lock'
      - '**/pyproject.toml'
jobs:
  vulnerability-checks:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8"]
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Setup
        uses: ./actions/setup-environment
      - name: Run nox
        run: poetry run nox -s safety
```


Footnotes

[^1]: https://pypi.org/project/safety/